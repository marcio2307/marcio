<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Push (Render) — Pai Márcio de Oxóssi</title>

  <style>
    :root{
      --bg:#0b0b0b;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);
      --muted: rgba(255,255,255,.80);
      --text:#fff;
      --shadow: 0 18px 44px rgba(0,0,0,0.60);
      --radius: 18px;
      --btnShadow: 0 14px 30px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 420px at 15% 10%, rgba(255,255,255,0.07), rgba(0,0,0,0) 60%),
        radial-gradient(900px 420px at 85% 20%, rgba(255,255,255,0.05), rgba(0,0,0,0) 60%),
        radial-gradient(1200px 520px at 50% 120%, rgba(255,255,255,0.04), rgba(0,0,0,0) 65%),
        var(--bg);
      color:var(--text);
      padding:16px 12px 24px;
    }

    .wrap{ max-width: 920px; margin: 0 auto; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:6px 2px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }

    .appIcon{
      width:44px;height:44px;
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 26px rgba(0,0,0,.45);
      flex:0 0 auto;
    }
    .appIcon svg{ width:22px;height:22px; opacity:.95; }

    h1{ margin:0; font-size:16px; font-weight:900; letter-spacing:.2px; }
    .sub{ margin:4px 0 0; font-size:13px; color:var(--muted); line-height:1.35; }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin:12px 0 10px;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.28);
      font-size:13px;
      color:rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .pill b{ font-weight:900; }

    label{
      display:block;
      font-size:12px;
      color:rgba(255,255,255,.82);
      margin:10px 0 6px;
    }

    input,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.10);
      color:#fff;
      outline:none;
      box-shadow: 0 8px 18px rgba(0,0,0,.20);
      font-family:inherit;
    }
    input::placeholder, textarea::placeholder{ color:rgba(255,255,255,.55); }
    textarea{ min-height:120px; resize:vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    button{
      height:52px;
      padding:0 14px;
      border:0;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      letter-spacing:.3px;
      width:100%;
      transition: transform .12s ease, filter .18s ease;
    }
    button:active{ transform: translateY(1px); }

    #send{
      background: linear-gradient(180deg, rgba(255,255,255,.22) 0%, rgba(255,255,255,.10) 100%);
      color:#fff;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: var(--btnShadow);
    }
    #send:hover{ filter:brightness(1.06); }

    #refresh, #openHealth, #openSubs, #openTest{
      background: rgba(255,255,255,.08);
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    #refresh:hover, #openHealth:hover, #openSubs:hover, #openTest:hover{ filter:brightness(1.06); }

    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.28);
      color:rgba(255,255,255,.90);
      font-size:13px;
      line-height:1.35;
      word-break:break-word;
    }

    hr{
      border:0;
      border-top:1px solid rgba(255,255,255,.10);
      margin:14px 0;
    }

    .tests{
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    code{
      background:rgba(0,0,0,.35);
      padding:2px 6px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
    }

    .smallRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .hint{
      margin-top:8px;
      font-size:12px;
      color:rgba(255,255,255,.78);
      line-height:1.35;
    }

    @media (min-width:720px){
      button{ width:auto; }
      #send{ min-width: 240px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="appIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 22a2.2 2.2 0 0 0 2.2-2.2h-4.4A2.2 2.2 0 0 0 12 22Z" fill="white" opacity=".92"/>
            <path d="M18 10.5c0-3.2-2-5.6-5-6.2V3a1 1 0 1 0-2 0v1.3c-3 .6-5 3-5 6.2V16l-1.4 1.4A1 1 0 0 0 5.3 19h13.4a1 1 0 0 0 .7-1.7L18 16v-5.5Z" fill="white" opacity=".92"/>
          </svg>
        </div>
        <div>
          <h1>Painel de Notificações — Pai Márcio de Oxóssi ✅</h1>
          <div class="sub">Envie Push para os PWAs registrados (Render → Web Push).</div>
        </div>
      </div>

      <div class="topRow">
        <div class="pill">API: <b id="apiHost">—</b></div>
        <div class="pill">Inscritos: <b id="subs">0</b></div>
      </div>

      <label for="api">URL da API (Render)</label>
      <input id="api" placeholder="https://marcio-1.onrender.com" value="https://marcio-1.onrender.com" />
      <div class="hint">
        Se você hospedar este painel fora do Render (Hostinger/GitHub), ele precisa apontar para o Render aqui.
      </div>

      <label for="title">Título</label>
      <input id="title" placeholder="Pai Márcio de Oxóssi" value="Pai Márcio de Oxóssi" />

      <label for="body">Mensagem</label>
      <textarea id="body" rows="3" placeholder="Escreva a mensagem..."></textarea>

      <label for="url">URL ao clicar</label>
      <input id="url" value="https://marcio2307.github.io/cartomantesonline/inicio.html?pwa=true" />

      <label for="icon">Ícone (opcional)</label>
      <input id="icon" value="https://marcio2307.github.io/cartomantesonline/logo-v2.png" />

      <div class="row">
        <button id="send">Enviar para todos</button>
        <button id="refresh">Atualizar inscritos</button>
      </div>

      <div class="smallRow">
        <button id="openHealth">Abrir /health</button>
        <button id="openSubs">Abrir /api/subscribers</button>
        <button id="openTest">Enviar teste (mensagem rápida)</button>
      </div>

      <div id="status" class="status">—</div>

      <hr>

      <div class="tests">
        Testes:
        <div>• <code>/health</code></div>
        <div>• <code>/api/subscribers</code></div>
        <div>• <code>/api/send</code></div>
        <div class="hint">
          Se a notificação não chegar: geralmente é <b>subscription inválida</b> (VAPID diferente), ou o PWA não está instalado no iPhone.
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const setStatus = (m) => $("status").textContent = m;

    function cleanBase(u){ return (u || "").trim().replace(/\/+$/, ""); }

    async function safeJson(res){
      const txt = await res.text().catch(()=> "");
      try { return JSON.parse(txt); } catch { return { raw: txt }; }
    }

    function getApiBase(){
      const v = cleanBase($("api").value);
      return v || location.origin;
    }

    function updateApiHost(){
      const API_BASE = getApiBase();
      $("apiHost").textContent = API_BASE.replace("https://","").replace("http://","");
      return API_BASE;
    }

    async function refreshSubs(){
      const API_BASE = updateApiHost();
      const r = await fetch(API_BASE + "/api/subscribers", { cache: "no-store" });
      const j = await safeJson(r);

      if(!r.ok){
        throw new Error("Falha /api/subscribers: " + r.status + " " + (j.error || j.raw || ""));
      }

      $("subs").textContent = j.total ?? 0;
      setStatus("✅ Inscritos atualizados.");
    }

    $("refresh").onclick = () => refreshSubs().catch(e => setStatus("❌ " + (e?.message || e)));

    $("openHealth").onclick = () => {
      const API_BASE = updateApiHost();
      window.open(API_BASE + "/health", "_blank");
    };
    $("openSubs").onclick = () => {
      const API_BASE = updateApiHost();
      window.open(API_BASE + "/api/subscribers", "_blank");
    };

    async function sendPush(payload){
      const API_BASE = updateApiHost();
      const res = await fetch(API_BASE + "/api/send", {
        cache:"no-store",
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      const j = await safeJson(res);

      if(!res.ok){
        throw new Error("Erro no /api/send: " + res.status + " " + (j.error || j.raw || ""));
      }
      return j;
    }

    $("send").onclick = async () => {
      try{
        const msg = $("body").value.trim();
        if(!msg){
          setStatus("❌ Digite uma mensagem antes de enviar.");
          return;
        }

        setStatus("Enviando...");

        const j = await sendPush({
          title: $("title").value.trim() || "Pai Márcio de Oxóssi",
          body: msg,
          url: $("url").value.trim(),
          icon: $("icon").value.trim()
        });

        setStatus("✅ Enviado. success=" + (j.success ?? 0) + " failed=" + (j.failed ?? 0) + " total=" + (j.total ?? 0));
        await refreshSubs();
      }catch(e){
        setStatus("❌ " + (e?.message || e));
      }
    };

    $("openTest").onclick = async () => {
      try{
        setStatus("Enviando teste...");
        const j = await sendPush({
          title: "Pai Márcio de Oxóssi ✅",
          body: "Teste do painel (Render) — " + new Date().toLocaleString("pt-BR"),
          url: $("url").value.trim(),
          icon: $("icon").value.trim()
        });
        setStatus("✅ Teste enviado. success=" + (j.success ?? 0) + " failed=" + (j.failed ?? 0) + " total=" + (j.total ?? 0));
        await refreshSubs();
      }catch(e){
        setStatus("❌ " + (e?.message || e));
      }
    };

    // init
    updateApiHost();
    refreshSubs().catch((e)=> setStatus("⚠️ " + (e?.message || e)));
  </script>
</body>
</html>
